<div class="modal-overlay" (click)="close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- Loading State -->
    @if (loading()) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando detalles del documento...</p>
      </div>
    }

    <!-- Document Details -->
    @if (!loading() && document()) {
      <!-- Header -->
      <div class="modal-header">
        <div>
          <h2 class="modal-title">üìÑ Detalles del Documento</h2>
          <p class="tracking-code">{{ document()!.trackingCode }}</p>
        </div>
        <button class="modal-close" (click)="close()">‚úï</button>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab" 
          [class.active]="activeTab() === 'info'"
          (click)="setTab('info')"
        >
          üìã Informaci√≥n
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab() === 'history'"
          (click)="setTab('history')"
        >
          üïê Historial ({{ document()!.movements.length }})
        </button>
      </div>

      <!-- Tab Content -->
      <div class="modal-body">
        
        <!-- Informaci√≥n General -->
        @if (activeTab() === 'info') {
          <div class="info-section">
            
            <!-- Estado con opci√≥n de cambio -->
            <div class="info-grid">
              <div class="info-item">
                <label class="info-label">Estado Actual</label>
                <span 
                  class="status-badge" 
                  [style.background-color]="document()!.status.color"
                >
                  {{ document()!.status.nombre }}
                </span>
              </div>

              <!-- Selector para cambiar estado -->
              @if (availableStatuses().length > 0) {
                <div class="info-item status-change-section">
                  <label class="info-label">Cambiar Estado</label>
                  <div class="status-change-controls">
                    <select 
                      [(ngModel)]="selectedStatusId" 
                      class="status-select"
                      [disabled]="changingStatus()"
                    >
                      @for (status of availableStatuses(); track status.id) {
                        <option [value]="status.id">{{ status.nombre }}</option>
                      }
                    </select>
                    <button 
                      (click)="changeStatus()" 
                      class="btn-change-status"
                      [disabled]="changingStatus() || selectedStatusId === document()!.status.id"
                    >
                      @if (changingStatus()) {
                        <span>Cambiando...</span>
                      } @else {
                        <span>‚úì Cambiar</span>
                      }
                    </button>
                  </div>
                  <small class="status-help-text">
                    Solo se pueden cambiar manualmente entre Pendiente y En Proceso
                  </small>
                </div>
              }
            </div>

            <!-- Documento -->
            <div class="section">
              <h3 class="section-title">üìÑ Informaci√≥n del Documento</h3>
              
              @if (document()!.documentType) {
                <div class="info-item">
                  <label class="info-label">Tipo de Documento</label>
                  <p class="info-value">{{ document()!.documentType.nombre }}</p>
                </div>
              }

              <div class="info-item">
                <label class="info-label">Asunto</label>
                <p class="info-value">{{ document()!.asunto }}</p>
              </div>

              @if (document()!.descripcion) {
                <div class="info-item">
                  <label class="info-label">Descripci√≥n</label>
                  <p class="info-value">{{ document()!.descripcion }}</p>
                </div>
              }

              <div class="info-item">
                <label class="info-label">Fecha de Recepci√≥n</label>
                <p class="info-value">{{ formatDate(document()!.created_at) }}</p>
              </div>

              <div class="info-item">
                <label class="info-label">√Årea Actual</label>
                <p class="info-value">
                  {{ document()!.currentArea.nombre }} ({{ document()!.currentArea.sigla }})
                </p>
              </div>
            </div>

            <!-- Remitente -->
            <div class="section">
              <h3 class="section-title">üë§ Informaci√≥n del Remitente</h3>
              
              <div class="info-grid">
                @if (document()!.sender.nombreCompleto) {
                  <div class="info-item">
                    <label class="info-label">Nombre Completo</label>
                    <p class="info-value">{{ document()!.sender.nombreCompleto }}</p>
                  </div>
                }

                @if (document()!.sender.tipoDocumento && document()!.sender.numeroDocumento) {
                  <div class="info-item">
                    <label class="info-label">{{ document()!.sender.tipoDocumento }}</label>
                    <p class="info-value">{{ document()!.sender.numeroDocumento }}</p>
                  </div>
                }
              </div>

              @if (document()!.sender.email || document()!.sender.telefono) {
                <div class="info-grid">
                  @if (document()!.sender.email) {
                    <div class="info-item">
                      <label class="info-label">Email</label>
                      <p class="info-value">{{ document()!.sender.email }}</p>
                    </div>
                  }

                  @if (document()!.sender.telefono) {
                    <div class="info-item">
                      <label class="info-label">Tel√©fono</label>
                      <p class="info-value">{{ document()!.sender.telefono }}</p>
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Archivos Adjuntos -->
            @if (document()!.attachments && document()!.attachments!.length > 0) {
              <div class="section">
                <h3 class="section-title">üìé Archivos Adjuntos ({{ document()!.attachments!.length }})</h3>
                
                <div class="attachments-list">
                  @for (attachment of document()!.attachments; track attachment.id) {
                    <div class="attachment-item">
                      <div class="attachment-info">
                        <span class="file-icon">{{ getFileIcon(attachment.fileType) }}</span>
                        <div class="file-details">
                          <p class="file-name">{{ attachment.originalName }}</p>
                          <p class="file-meta">
                            {{ formatFileSize(attachment.fileSize) }} 
                            ¬∑ {{ formatDate(attachment.uploadedAt) }}
                            @if (attachment.uploader) {
                              ¬∑ Por: {{ attachment.uploader.nombre }}
                            }
                          </p>
                        </div>
                      </div>
                      <button 
                        class="btn-download"
                        (click)="downloadAttachment(document()!.id, attachment.id, attachment.originalName)"
                        title="Descargar archivo">
                        ‚¨áÔ∏è Descargar
                      </button>
                    </div>
                  }
                </div>
              </div>
            }

          </div>
        }

        <!-- Historial de Movimientos -->
        @if (activeTab() === 'history') {
          <div class="history-section">
            @if (document()!.movements.length === 0) {
              <div class="empty-history">
                <p>No hay movimientos registrados</p>
              </div>
            } @else {
              <div class="timeline">
                @for (movement of document()!.movements; track movement.id) {
                  <div class="timeline-item">
                    <div class="timeline-icon">
                      {{ getActionIcon(movement.accion) }}
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <h4 class="timeline-action">{{ movement.accion }}</h4>
                        <span class="timeline-date">{{ formatDate(movement.timestamp) }}</span>
                      </div>
                      
                      <div class="timeline-details">
                        @if (movement.fromArea) {
                          <p class="timeline-from">
                            <strong>De:</strong> {{ movement.fromArea.nombre }} ({{ movement.fromArea.sigla }})
                          </p>
                        }
                        
                        @if (movement.toArea) {
                          <p class="timeline-to">
                            <strong>A:</strong> {{ movement.toArea.nombre }} ({{ movement.toArea.sigla }})
                          </p>
                        }

                        @if (movement.user) {
                          <p class="timeline-user">
                            <strong>Usuario:</strong> {{ movement.user.nombre }} - {{ movement.user.role.nombre }}
                          </p>
                        }

                        @if (movement.observacion) {
                          <div class="timeline-observation">
                            <strong>Observaci√≥n:</strong>
                            <p>{{ movement.observacion }}</p>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }

      </div>

      <!-- Footer con Acciones -->
      <div class="modal-footer">
        <div class="footer-actions">
          <!-- Botones de acci√≥n -->
          <div class="action-buttons">
            @if (document()!.status.nombre !== 'Archivado' && document()!.status.nombre !== 'Atendido') {
              <button 
                class="btn-success" 
                (click)="finalizeDocument()"
                [disabled]="finalizingDocument()"
              >
                @if (finalizingDocument()) {
                  <span>‚è≥ Atendiendo...</span>
                } @else {
                  <span>‚úÖ Atender Documento</span>
                }
              </button>
            }

            @if (document()!.status.nombre !== 'Archivado') {
              <button 
                class="btn-warning" 
                (click)="archiveDocument()"
                [disabled]="archivingDocument()"
              >
                @if (archivingDocument()) {
                  <span>‚è≥ Archivando...</span>
                } @else {
                  <span>üì¶ Archivar</span>
                }
              </button>
            }
          </div>

          <!-- Bot√≥n cerrar -->
          <button class="btn-secondary" (click)="close()">
            Cerrar
          </button>
        </div>
      </div>
    }

  </div>
</div>
