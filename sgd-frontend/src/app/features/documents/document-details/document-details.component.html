<div class="modal-overlay" (click)="close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    
    <!-- Loading State -->
    @if (loading()) {
      <div class="loading-container">
        <div class="spinner"></div>
        <p>Cargando detalles del documento...</p>
      </div>
    }

    <!-- Document Details -->
    @if (!loading() && document()) {
      <!-- Header -->
      <div class="modal-header">
        <div>
          <h2 class="modal-title">üìÑ Detalles del Documento</h2>
          <p class="tracking-code">{{ document()!.trackingCode }}</p>
        </div>
        <button class="modal-close" (click)="close()">‚úï</button>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button 
          class="tab" 
          [class.active]="activeTab() === 'info'"
          (click)="setTab('info')"
        >
          üìã Informaci√≥n
        </button>
        <button 
          class="tab" 
          [class.active]="activeTab() === 'history'"
          (click)="setTab('history')"
        >
          üïê Historial ({{ document()!.movements.length }})
        </button>
        @if (document()!.attachments && document()!.attachments!.length > 0) {
          <button 
            class="tab" 
            [class.active]="activeTab() === 'preview'"
            (click)="setTab('preview')"
          >
            üëÅÔ∏è Previsualizar
          </button>
        }
        <button 
          class="tab tab-versions" 
          (click)="openVersionsModal()"
          title="Ver versiones del documento"
        >
          üìö Versiones
          @if (versionsCount() > 0) {
            <span class="versions-badge">{{ versionsCount() }}</span>
          }
        </button>
      </div>

      <!-- Tab Content -->
      <div class="modal-body">
        
        <!-- Informaci√≥n General -->
        @if (activeTab() === 'info') {
          <div class="info-section">
            
            <!-- Estado con opci√≥n de cambio -->
            <div class="info-grid">
              <div class="info-item">
                <label class="info-label">Estado Actual</label>
                <span 
                  class="status-badge" 
                  [style.background-color]="document()!.status.color"
                >
                  {{ document()!.status.nombre }}
                </span>
              </div>

              <!-- Selector para cambiar estado -->
              @if (availableStatuses().length > 0) {
                <div class="info-item status-change-section">
                  <label class="info-label">Cambiar Estado</label>
                  <div class="status-change-controls">
                    <select 
                      [(ngModel)]="selectedStatusId" 
                      class="status-select"
                      [disabled]="changingStatus()"
                    >
                      @for (status of availableStatuses(); track status.id) {
                        <option [value]="status.id">{{ status.nombre }}</option>
                      }
                    </select>
                    <button 
                      (click)="changeStatus()" 
                      class="btn-change-status"
                      [disabled]="changingStatus() || selectedStatusId === document()!.status.id"
                    >
                      @if (changingStatus()) {
                        <span>Cambiando...</span>
                      } @else {
                        <span>‚úì Cambiar</span>
                      }
                    </button>
                  </div>
                  <small class="status-help-text">
                    Solo se pueden cambiar manualmente entre Pendiente y En Proceso
                  </small>
                </div>
              }
            </div>

            <!-- Documento -->
            <div class="section">
              <h3 class="section-title">üìÑ Informaci√≥n del Documento</h3>
              
              @if (document()!.documentType) {
                <div class="info-item">
                  <label class="info-label">Tipo de Documento</label>
                  <p class="info-value">{{ document()!.documentType.nombre }}</p>
                </div>
              }

              <div class="info-item">
                <label class="info-label">Asunto</label>
                <p class="info-value">{{ document()!.asunto }}</p>
              </div>

              @if (document()!.descripcion) {
                <div class="info-item">
                  <label class="info-label">Descripci√≥n</label>
                  <p class="info-value">{{ document()!.descripcion }}</p>
                </div>
              }

              <div class="info-item">
                <label class="info-label">Fecha de Recepci√≥n</label>
                <p class="info-value">{{ formatDate(document()!.created_at) }}</p>
              </div>

              <div class="info-item">
                <label class="info-label">√Årea Actual</label>
                <p class="info-value">
                  {{ document()!.currentArea.nombre }} ({{ document()!.currentArea.sigla }})
                </p>
              </div>
            </div>

            <!-- Remitente -->
            <div class="section">
              <h3 class="section-title">
                @if (document()!.sender.tipoPersona === 'juridica') {
                  üè¢ Informaci√≥n de la Entidad
                } @else {
                  üë§ Informaci√≥n del Remitente
                }
              </h3>
              
              <!-- Indicador de tipo de persona -->
              <div class="info-item tipo-persona-badge">
                <span class="badge badge-info">
                  @if (document()!.sender.tipoPersona === 'juridica') {
                    Persona Jur√≠dica
                  } @else {
                    Persona Natural
                  }
                </span>
              </div>

              <!-- PERSONA NATURAL -->
              @if (document()!.sender.tipoPersona === 'natural' || !document()!.sender.tipoPersona) {
                <div class="info-grid">
                  <!-- Nombres completos -->
                  @if (document()!.sender.nombres && document()!.sender.apellidoPaterno) {
                    <div class="info-item full-width">
                      <label class="info-label">Nombre Completo</label>
                      <p class="info-value">
                        {{ document()!.sender.nombres }} 
                        {{ document()!.sender.apellidoPaterno }} 
                        {{ document()!.sender.apellidoMaterno || '' }}
                      </p>
                    </div>
                  } @else if (document()!.sender.nombreCompleto) {
                    <div class="info-item full-width">
                      <label class="info-label">Nombre Completo</label>
                      <p class="info-value">{{ document()!.sender.nombreCompleto }}</p>
                    </div>
                  }

                  <!-- Documento de identidad -->
                  @if (document()!.sender.tipoDocumento && document()!.sender.numeroDocumento) {
                    <div class="info-item">
                      <label class="info-label">{{ document()!.sender.tipoDocumento }}</label>
                      <p class="info-value">{{ document()!.sender.numeroDocumento }}</p>
                    </div>
                  }
                </div>
              }

              <!-- PERSONA JUR√çDICA -->
              @if (document()!.sender.tipoPersona === 'juridica') {
                <!-- Datos de la empresa -->
                <div class="subsection empresa-section">
                  <h4 class="subsection-title">Datos de la Empresa</h4>
                  <div class="info-grid">
                    @if (document()!.sender.ruc) {
                      <div class="info-item">
                        <label class="info-label">RUC</label>
                        <p class="info-value">{{ document()!.sender.ruc }}</p>
                      </div>
                    }

                    @if (document()!.sender.nombreEmpresa) {
                      <div class="info-item">
                        <label class="info-label">Raz√≥n Social</label>
                        <p class="info-value">{{ document()!.sender.nombreEmpresa }}</p>
                      </div>
                    }
                  </div>
                </div>

                <!-- Representante Legal -->
                @if (document()!.sender.representanteNombres || document()!.sender.representanteNumDoc) {
                  <div class="subsection representante-section">
                    <h4 class="subsection-title">Representante Legal</h4>
                    <div class="info-grid">
                      @if (document()!.sender.representanteNombres) {
                        <div class="info-item full-width">
                          <label class="info-label">Nombre Completo</label>
                          <p class="info-value">
                            {{ document()!.sender.representanteNombres }} 
                            {{ document()!.sender.representanteApellidoPaterno || '' }} 
                            {{ document()!.sender.representanteApellidoMaterno || '' }}
                          </p>
                        </div>
                      }

                      @if (document()!.sender.representanteTipoDoc && document()!.sender.representanteNumDoc) {
                        <div class="info-item">
                          <label class="info-label">{{ document()!.sender.representanteTipoDoc }}</label>
                          <p class="info-value">{{ document()!.sender.representanteNumDoc }}</p>
                        </div>
                      }
                    </div>
                  </div>
                }
              }

              <!-- Datos de contacto (com√∫n para ambos) -->
              <div class="subsection contacto-section">
                <h4 class="subsection-title">Datos de Contacto</h4>
                <div class="info-grid">
                  @if (document()!.sender.email) {
                    <div class="info-item">
                      <label class="info-label">üìß Email</label>
                      <p class="info-value">{{ document()!.sender.email }}</p>
                    </div>
                  }

                  @if (document()!.sender.telefono) {
                    <div class="info-item">
                      <label class="info-label">üì± Tel√©fono</label>
                      <p class="info-value">{{ document()!.sender.telefono }}</p>
                    </div>
                  }
                </div>
              </div>

              <!-- Direcci√≥n (com√∫n para ambos) -->
              @if (document()!.sender.departamento || document()!.sender.direccionCompleta || document()!.sender.direccion) {
                <div class="subsection direccion-section">
                  <h4 class="subsection-title">Direcci√≥n</h4>
                  
                  @if (document()!.sender.departamento) {
                    <div class="info-grid">
                      <div class="info-item">
                        <label class="info-label">Departamento</label>
                        <p class="info-value">{{ document()!.sender.departamento }}</p>
                      </div>

                      @if (document()!.sender.provincia) {
                        <div class="info-item">
                          <label class="info-label">Provincia</label>
                          <p class="info-value">{{ document()!.sender.provincia }}</p>
                        </div>
                      }

                      @if (document()!.sender.distrito) {
                        <div class="info-item">
                          <label class="info-label">Distrito</label>
                          <p class="info-value">{{ document()!.sender.distrito }}</p>
                        </div>
                      }
                    </div>
                  }

                  @if (document()!.sender.direccionCompleta || document()!.sender.direccion) {
                    <div class="info-item full-width">
                      <label class="info-label">üìç Direcci√≥n Completa</label>
                      <p class="info-value">{{ document()!.sender.direccionCompleta || document()!.sender.direccion }}</p>
                    </div>
                  }
                </div>
              }
            </div>

            <!-- Versiones del Documento -->
            @if (versionsCount() > 0) {
              <div class="section">
                <div class="section-header-with-action">
                  <h3 class="section-title">üìö Versiones del Documento ({{ versionsCount() }})</h3>
                  <button class="btn-link" (click)="openVersionsModal()">Ver todas ‚Üí</button>
                </div>
                
                <div class="versions-summary">
                  <div class="version-current-badge">
                    <span class="badge badge-version">Versi√≥n {{ latestVersionNumber() }}</span>
                    @if (latestVersion()) {
                      @if (latestVersion()!.tieneSello) {
                        <span class="badge badge-sello">‚úÖ Sello</span>
                      }
                      @if (latestVersion()!.tieneFirma) {
                        <span class="badge badge-firma">‚úçÔ∏è Firma Electr√≥nica</span>
                      }
                    }
                  </div>
                  @if (latestVersion()) {
                    <div class="version-info-box">
                      <p class="version-detail">
                        <strong>Archivo:</strong> {{ latestVersion()!.originalName }}
                      </p>
                      <p class="version-detail">
                        <strong>Tama√±o:</strong> {{ formatFileSize(latestVersion()!.fileSize) }}
                      </p>
                      @if (latestVersion()!.descripcion) {
                        <p class="version-detail">
                          <strong>Descripci√≥n:</strong> {{ latestVersion()!.descripcion }}
                        </p>
                      }
                      <p class="version-detail">
                        <strong>Subido:</strong> {{ formatDate(latestVersion()!.created_at) }}
                        @if (latestVersion()!.uploader) {
                          por {{ latestVersion()!.uploader.nombre }}
                        }
                      </p>
                    </div>
                  }
                </div>
              </div>
            }

            <!-- Archivos Adjuntos -->
            @if (document()!.attachments && document()!.attachments!.length > 0) {
              <div class="section">
                <h3 class="section-title">üìé Archivos Adjuntos ({{ document()!.attachments!.length }})</h3>
                
                <div class="attachments-list">
                  @for (attachment of document()!.attachments; track attachment.id) {
                    <div class="attachment-item">
                      <div class="attachment-info">
                        <span class="file-icon">{{ getFileIcon(attachment.fileType) }}</span>
                        <div class="file-details">
                          <p class="file-name">{{ attachment.originalName }}</p>
                          <p class="file-meta">
                            {{ formatFileSize(attachment.fileSize) }} 
                            ¬∑ {{ formatDate(attachment.uploadedAt) }}
                            @if (attachment.uploader) {
                              ¬∑ Por: {{ attachment.uploader.nombre }}
                            }
                          </p>
                        </div>
                      </div>
                      <button 
                        class="btn-download"
                        (click)="downloadAttachment(document()!.id, attachment.id, attachment.originalName)"
                        title="Descargar archivo">
                        ‚¨áÔ∏è Descargar
                      </button>
                    </div>
                  }
                </div>
              </div>
            }

          </div>
        }

        <!-- Historial de Movimientos -->
        @if (activeTab() === 'history') {
          <div class="history-section">
            @if (document()!.movements.length === 0) {
              <div class="empty-history">
                <p>No hay movimientos registrados</p>
              </div>
            } @else {
              <div class="timeline">
                @for (movement of document()!.movements; track movement.id) {
                  <div class="timeline-item">
                    <div class="timeline-icon">
                      {{ getActionIcon(movement.accion) }}
                    </div>
                    <div class="timeline-content">
                      <div class="timeline-header">
                        <h4 class="timeline-action">{{ movement.accion }}</h4>
                        <span class="timeline-date">{{ formatDate(movement.timestamp) }}</span>
                      </div>
                      
                      <div class="timeline-details">
                        @if (movement.fromArea) {
                          <p class="timeline-from">
                            <strong>De:</strong> {{ movement.fromArea.nombre }} ({{ movement.fromArea.sigla }})
                          </p>
                        }
                        
                        @if (movement.toArea) {
                          <p class="timeline-to">
                            <strong>A:</strong> {{ movement.toArea.nombre }} ({{ movement.toArea.sigla }})
                          </p>
                        }

                        @if (movement.user) {
                          <p class="timeline-user">
                            <strong>Usuario:</strong> {{ movement.user.nombre }}@if (movement.user.role) { - {{ movement.user.role.nombre }}}
                          </p>
                        }

                        @if (movement.observacion) {
                          <div class="timeline-observation">
                            <strong>Observaci√≥n:</strong>
                            <p>{{ movement.observacion }}</p>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        }

        <!-- Previsualizaci√≥n de Documentos -->
        @if (activeTab() === 'preview') {
          <div class="preview-section">
            <!-- Selector de archivos si hay m√∫ltiples -->
            @if (document()!.attachments!.length > 1) {
              <div class="file-selector">
                <label for="file-select">Seleccionar archivo:</label>
                <select id="file-select" (change)="previewAttachment(document()!.attachments![$any($event.target).selectedIndex])">
                  @for (attachment of document()!.attachments; track attachment.id; let i = $index) {
                    <option [value]="i" [selected]="selectedAttachment()?.id === attachment.id">
                      {{ attachment.originalName }}
                    </option>
                  }
                </select>
              </div>
            }

            <!-- Visor PDF -->
            @if (pdfSrc() && selectedAttachment()?.fileType.includes('pdf')) {
              <div class="pdf-viewer-container">
                <ngx-extended-pdf-viewer
                  [src]="pdfSrc()!"
                  height="75vh"
                  [textLayer]="true"
                  [showHandToolButton]="true"
                >
                </ngx-extended-pdf-viewer>
              </div>
            } @else if (selectedAttachment()?.fileType.includes('image')) {
              <div class="image-preview">
                <img [src]="pdfSrc()" [alt]="selectedAttachment()?.originalName" />
              </div>
            } @else {
              <div class="no-preview">
                <p>‚ö†Ô∏è No se puede previsualizar este tipo de archivo</p>
                <p>{{ selectedAttachment()?.originalName }}</p>
                <button 
                  class="btn-download"
                  (click)="downloadAttachment(document()!.id, selectedAttachment()!.id, selectedAttachment()!.originalName)"
                >
                  ‚¨áÔ∏è Descargar archivo
                </button>
              </div>
            }
          </div>
        }

      </div>

      <!-- Footer con Acciones -->
      <div class="modal-footer">
        <div class="footer-actions">
          <!-- Botones de acci√≥n -->
          <div class="action-buttons">
            @if (document()!.status.nombre !== 'Archivado' && document()!.status.nombre !== 'Atendido') {
              <button 
                class="btn-success" 
                (click)="finalizeDocument()"
                [disabled]="finalizingDocument()"
              >
                @if (finalizingDocument()) {
                  <span>‚è≥ Atendiendo...</span>
                } @else {
                  <span>‚úÖ Atender Documento</span>
                }
              </button>
            }

            @if (document()!.status.nombre !== 'Archivado') {
              <button 
                class="btn-warning" 
                (click)="archiveDocument()"
                [disabled]="archivingDocument()"
              >
                @if (archivingDocument()) {
                  <span>‚è≥ Archivando...</span>
                } @else {
                  <span>üì¶ Archivar</span>
                }
              </button>
            }
          </div>

          <!-- Bot√≥n cerrar -->
          <button class="btn-secondary" (click)="close()">
            Cerrar
          </button>
        </div>
      </div>
    }

  </div>
</div>

<!-- Modal de Versiones -->
@if (showVersionsModal()) {
  <app-document-versions-modal
    [documentId]="documentId"
    [documentTrackingCode]="document()!.trackingCode"
    (onClose)="closeVersionsModal()"
    (onVersionUploaded)="onVersionUploaded()"
  />
}
@if (showVersionsModal()) {
  <app-document-versions-modal
    [documentId]="documentId"
    [documentTrackingCode]="document()?.trackingCode || ''"
    (onClose)="closeVersionsModal()"
    (onVersionUploaded)="onVersionUploaded()"
  />
}
