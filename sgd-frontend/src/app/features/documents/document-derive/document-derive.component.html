<div class="modal-overlay" (click)="close()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <div>
        <h2 class="modal-title">üì§ Derivar Documento</h2>
        <p class="modal-subtitle">{{ documentCode }} - {{ documentSubject }}</p>
      </div>
      <button class="modal-close" (click)="close()">‚úï</button>
    </div>

    <div class="modal-body">
      @if (errorMessage()) {
        <div class="alert alert-error">
          ‚úó {{ errorMessage() }}
        </div>
      }

      <!-- √Årea actual -->
      <div class="info-box">
        <span class="info-label">üìç √Årea actual:</span>
        <span class="info-value">{{ currentArea }}</span>
      </div>

      <!-- Seleccionar √°rea destino -->
      <div class="form-group">
        <label class="form-label">
          √Årea de destino <span class="required">*</span>
        </label>
        <select 
          [(ngModel)]="formData().toAreaId"
          (ngModelChange)="onAreaChange()"
          class="form-select"
        >
          <option [value]="0" disabled>Seleccionar √°rea...</option>
          @for (area of areas(); track area.id) {
            <option [value]="area.id">
              {{ area.nombre }} ({{ area.sigla }})
            </option>
          }
        </select>
        <p class="form-hint">Selecciona el √°rea a la que deseas derivar el documento</p>
      </div>

      <!-- Seleccionar usuario (opcional) -->
      <div class="form-group">
        <label class="form-label">
          Usuario responsable (opcional)
        </label>
        
        @if (loadingUsers()) {
          <div class="loading-users">
            <div class="spinner-small"></div>
            <span>Cargando usuarios...</span>
          </div>
        } @else if (formData().toAreaId === 0) {
          <p class="form-hint disabled">Primero selecciona un √°rea</p>
        } @else if (users().length === 0) {
          <p class="form-hint disabled">No hay usuarios disponibles en esta √°rea</p>
        } @else {
          <select 
            [(ngModel)]="formData().toUserId"
            class="form-select"
          >
            <option [value]="undefined">Sin asignar (√°rea en general)</option>
            @for (user of users(); track user.id) {
              <option [value]="user.id">
                {{ user.nombre }} - {{ user.role?.nombre }}
              </option>
            }
          </select>
          <p class="form-hint">Opcionalmente asigna el documento a un usuario espec√≠fico</p>
        }
      </div>

      <!-- Observaci√≥n -->
      <div class="form-group">
        <label class="form-label">
          Observaci√≥n <span class="required">*</span>
        </label>
        <textarea 
          [(ngModel)]="formData().observacion"
          class="form-textarea"
          rows="4"
          placeholder="Motivo de la derivaci√≥n, instrucciones o comentarios..."
        ></textarea>
        <p class="form-hint">Describe el motivo de la derivaci√≥n</p>
      </div>

      <!-- Resumen -->
      @if (formData().toAreaId) {
        <div class="summary-box">
          <h4 class="summary-title">üìã Resumen de la derivaci√≥n</h4>
          <div class="summary-item">
            <span class="summary-label">De:</span>
            <span class="summary-value">{{ currentArea }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">A:</span>
            <span class="summary-value">
              {{ getAreaName(formData().toAreaId) }}
              @if (formData().toUserId) {
                ‚Üí {{ getUserName(formData().toUserId) }}
              }
            </span>
          </div>
        </div>
      }
    </div>

    <div class="modal-footer">
      <button class="btn-secondary" (click)="close()" [disabled]="loading()">
        Cancelar
      </button>
      <button 
        class="btn-primary" 
        (click)="derive()"
        [disabled]="loading() || !formData().toAreaId || !formData().observacion"
      >
        @if (loading()) {
          <span class="spinner-small"></span>
        }
        üì§ Derivar Documento
      </button>
    </div>
  </div>
</div>
