<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="brand" (click)="navigateToHome()">
        <svg width="32" height="32" viewBox="0 0 24 24" fill="currentColor">
          <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
        </svg>
        <span>SGD - Dashboard</span>
      </div>
      
      <div class="user-menu">
        <div class="user-info">
          <span class="user-name">{{ userName() }}</span>
          <span class="user-role">{{ userRole() }} - {{ userArea() }}</span>
        </div>
        
        <!-- Panel de Notificaciones -->
        <app-notifications-panel />
        
        <button class="btn-bandeja" routerLink="/bandeja">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
          Mi Bandeja
        </button>
        
        <button class="btn-admin" routerLink="/admin">
          ‚öôÔ∏è Administraci√≥n
        </button>
        <button class="btn-logout" (click)="onLogout()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span>Total Documentos</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().total }}</div>
      </div>

      <div class="stat-card stat-recibidos">
        <div class="stat-header">
          <span>Recibidos</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().recibidos }}</div>
      </div>

      <div class="stat-card stat-proceso">
        <div class="stat-header">
          <span>En Proceso</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().enProceso }}</div>
      </div>

      <div class="stat-card stat-finalizados">
        <div class="stat-header">
          <span>Finalizados</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().finalizados }}</div>
      </div>

      <div class="stat-card stat-urgentes">
        <div class="stat-header">
          <span>Urgentes</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().urgentes }}</div>
      </div>
    </div>

    <!-- Filters & Table Section -->
    <div class="documents-section">
      <div class="section-header">
        <h2>Gesti√≥n de Documentos</h2>
        <button class="btn-refresh" (click)="loadDocuments()" [disabled]="loading()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          {{ loading() ? 'Cargando...' : 'Actualizar' }}
        </button>
      </div>

      <!-- Filters -->
      <div class="filters-container">
        <div class="filter-group">
          <input 
            type="text" 
            placeholder="Buscar por c√≥digo, asunto o remitente..."
            [(ngModel)]="searchTerm"
            (input)="applyFilters()"
            class="filter-search"
          />
        </div>
        
        <div class="filter-group">
          <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="filter-select">
            <option value="">Todos los estados</option>
            <option value="Recibido">Recibido</option>
            <option value="En proceso">En proceso</option>
            <option value="Finalizado">Finalizado</option>
            <option value="Atendido">Atendido</option>
          </select>
        </div>

        <div class="filter-group">
          <select [(ngModel)]="priorityFilter" (change)="applyFilters()" class="filter-select">
            <option value="">Todas las prioridades</option>
            <option value="baja">Baja</option>
            <option value="normal">Normal</option>
            <option value="alta">Alta</option>
            <option value="urgente">Urgente</option>
          </select>
        </div>

        <button class="btn-clear" (click)="clearFilters()" *ngIf="searchTerm || statusFilter || priorityFilter">
          Limpiar filtros
        </button>
      </div>

      <!-- Documents Table -->
      <div class="table-container">
        <div class="loading-state" *ngIf="loading()">
          <div class="spinner"></div>
          <p>Cargando documentos...</p>
        </div>

        <div class="empty-state" *ngIf="!loading() && filteredDocuments().length === 0">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p>No se encontraron documentos</p>
        </div>

        <table class="documents-table" *ngIf="!loading() && filteredDocuments().length > 0">
          <thead>
            <tr>
              <th class="sortable" (click)="sortBy('trackingCode')">
                C√≥digo {{ getSortIcon('trackingCode') }}
              </th>
              <th class="sortable" (click)="sortBy('asunto')">
                Asunto {{ getSortIcon('asunto') }}
              </th>
              <th class="sortable" (click)="sortBy('sender')">
                Remitente {{ getSortIcon('sender') }}
              </th>
              <th class="sortable" (click)="sortBy('documentType')">
                Tipo {{ getSortIcon('documentType') }}
              </th>
              <th class="sortable" (click)="sortBy('status')">
                Estado {{ getSortIcon('status') }}
              </th>
              <th class="sortable" (click)="sortBy('prioridad')">
                Prioridad {{ getSortIcon('prioridad') }}
              </th>
              <th class="sortable" (click)="sortBy('currentArea')">
                √Årea Actual {{ getSortIcon('currentArea') }}
              </th>
              <th class="sortable" (click)="sortBy('created_at')">
                Fecha {{ getSortIcon('created_at') }}
              </th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let doc of paginatedDocuments()">
              <td class="code">{{ doc.trackingCode }}</td>
              <td class="subject">{{ doc.asunto }}</td>
              <td>{{ doc.sender.nombreCompleto }}</td>
              <td>{{ doc.documentType.nombre }}</td>
              <td>
                <span class="status-badge" [style.background-color]="doc.status.color">
                  {{ doc.status.nombre }}
                </span>
              </td>
              <td>
                <span class="priority-badge" [ngClass]="getPriorityClass(doc.prioridad)">
                  {{ getPriorityLabel(doc.prioridad) }}
                </span>
              </td>
              <td>{{ doc.currentArea.nombre }}</td>
              <td class="date">{{ formatDate(doc.created_at) }}</td>
              <td class="actions-cell">
                <button class="btn-action btn-view" (click)="openDetailsModal(doc); $event.stopPropagation()" title="Ver detalles">
                  üëÅÔ∏è
                </button>
                <button class="btn-action btn-derive" (click)="openDeriveModal(doc); $event.stopPropagation()" title="Derivar">
                  üì§
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Paginaci√≥n -->
        <div class="pagination" *ngIf="!loading() && filteredDocuments().length > 0">
          <div class="pagination-info">
            <span>Mostrando {{ (currentPage() - 1) * pageSize() + 1 }} - {{ Math.min(currentPage() * pageSize(), filteredDocuments().length) }} de {{ filteredDocuments().length }} documentos</span>
            <select class="page-size-select" [(ngModel)]="pageSize" (ngModelChange)="setPageSize($event)">
              <option [value]="10">10 por p√°gina</option>
              <option [value]="25">25 por p√°gina</option>
              <option [value]="50">50 por p√°gina</option>
              <option [value]="100">100 por p√°gina</option>
            </select>
          </div>
          
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              (click)="previousPage()" 
              [disabled]="currentPage() === 1"
            >
              ‚Üê Anterior
            </button>
            
            <div class="pagination-pages">
              @for (page of [].constructor(totalPages()); track $index) {
                <button 
                  class="pagination-page" 
                  [class.active]="currentPage() === $index + 1"
                  (click)="goToPage($index + 1)"
                >
                  {{ $index + 1 }}
                </button>
              }
            </div>
            
            <button 
              class="pagination-btn" 
              (click)="nextPage()" 
              [disabled]="currentPage() === totalPages()"
            >
              Siguiente ‚Üí
            </button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Modal de Derivaci√≥n -->
@if (showDeriveModal()) {
  <app-document-derive
    [documentId]="selectedDocument().id"
    [documentCode]="selectedDocument().trackingCode"
    [documentSubject]="selectedDocument().asunto"
    [currentArea]="selectedDocument().currentArea.nombre"
    (onClose)="closeDeriveModal()"
    (onSuccess)="onDeriveSuccess()"
  ></app-document-derive>
}

<!-- Modal de Detalles -->
@if (showDetailsModal()) {
  <app-document-details
    [documentId]="selectedDocumentId()"
    (onClose)="closeDetailsModal()"
  ></app-document-details>
}
