<div class="dashboard-container">
  <!-- Header -->
  <header class="dashboard-header">
    <div class="header-content">
      <div class="brand" (click)="navigateToHome()">
        <img src="images/gb3.svg" alt="Logo Gobierno del Per√∫" class="brand-logo">
        <div class="brand-separator"></div>
        <span class="brand-text">SGD - Dashboard</span>
      </div>
      
      <div class="user-menu">
        <div class="user-info">
          <span class="user-name">{{ userName() }}</span>
          <span class="user-role">{{ userRole() }} - {{ userArea() }}</span>
        </div>
        
        <button class="btn-bandeja" routerLink="/bandeja">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4" />
          </svg>
          Mi Bandeja
        </button>
        
        <button 
          *hasAnyPermission="[
            'users.view.all', 
            'users.view.area', 
            'roles.view', 
            'areas.view', 
            'area_mgmt.users.view', 
            'area_mgmt.roles.view',
            'document_types.view',
            'area_mgmt.document_types.view',
            'categories.view',
            'area_mgmt.categories.full',
            'reports.view.all',
            'reports.view.area',
            'area_mgmt.reports.view'
          ]" 
          class="btn-admin" 
          routerLink="/admin"
        >
          ‚öôÔ∏è Administraci√≥n
        </button>
        <button class="btn-logout" (click)="onLogout()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
          Cerrar Sesi√≥n
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="dashboard-main">
    
    <!-- Stats Cards -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <span>Total Documentos</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().total }}</div>
      </div>

      <div class="stat-card stat-pendientes">
        <div class="stat-header">
          <span>Pendientes</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().pendientes }}</div>
      </div>

      <div class="stat-card stat-proceso">
        <div class="stat-header">
          <span>En Proceso</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().enProceso }}</div>
      </div>

      <div class="stat-card stat-finalizados">
        <div class="stat-header">
          <span>Atendidos</span>
          <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
        </div>
        <div class="stat-value">{{ stats().finalizados }}</div>
      </div>
    </div>

    <!-- Filters & Table Section -->
    <div class="documents-section">
      <div class="section-header">
        <h2>Gesti√≥n de Documentos</h2>
        <button class="btn-refresh" (click)="loadDocuments()" [disabled]="loading()">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          {{ loading() ? 'Cargando...' : 'Actualizar' }}
        </button>
      </div>

      <!-- Filters -->
      <div class="filters-container">
        <div class="filter-group">
          <input 
            type="text" 
            placeholder="Buscar por c√≥digo, asunto o remitente..."
            [(ngModel)]="searchTerm"
            (input)="applyFilters()"
            class="filter-search"
          />
        </div>
        
        <div class="filter-group">
          <select [(ngModel)]="statusFilter" (change)="applyFilters()" class="filter-select">
            <option value="">Todos los estados</option>
            <option value="Pendiente">Pendiente</option>
            <option value="En Proceso">En Proceso</option>
            <option value="Derivado">Derivado</option>
            <option value="Atendido">Atendido</option>
            <option value="Observado">Observado</option>
          </select>
        </div>

        <button class="btn-clear" (click)="clearFilters()" *ngIf="searchTerm || statusFilter">
          Limpiar filtros
        </button>
      </div>

      <!-- Documents Table -->
      <div class="table-container">
        <div class="loading-state" *ngIf="loading()">
          <div class="spinner"></div>
          <p>Cargando documentos...</p>
        </div>

        <div class="empty-state" *ngIf="!loading() && filteredDocuments().length === 0">
          <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <p>No se encontraron documentos</p>
        </div>

        <table class="documents-table" *ngIf="!loading() && filteredDocuments().length > 0">
          <thead>
            <tr>
              <th class="sortable" (click)="sortBy('trackingCode')">
                C√≥digo {{ getSortIcon('trackingCode') }}
              </th>
              <th class="sortable" (click)="sortBy('asunto')">
                Asunto {{ getSortIcon('asunto') }}
              </th>
              <th class="sortable" (click)="sortBy('sender')">
                Remitente {{ getSortIcon('sender') }}
              </th>
              <th class="sortable" (click)="sortBy('documentType')">
                Tipo {{ getSortIcon('documentType') }}
              </th>
              <th class="sortable" (click)="sortBy('status')">
                Estado {{ getSortIcon('status') }}
              </th>
              <th class="sortable" (click)="sortBy('currentArea')">
                √Årea Actual {{ getSortIcon('currentArea') }}
              </th>
              <th class="sortable" (click)="sortBy('created_at')">
                Fecha {{ getSortIcon('created_at') }}
              </th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let doc of paginatedDocuments()" class="clickable-row" (click)="openDetailsModal(doc)">
              <td class="code">{{ doc.trackingCode }}</td>
              <td class="subject">{{ doc.asunto }}</td>
              <td>{{ doc.sender.nombreCompleto || doc.sender.email || 'Sin datos' }}</td>
              <td>{{ doc.documentType?.nombre || 'Sin clasificar' }}</td>
              <td>
                <span class="status-badge" [style.background-color]="doc.status.color">
                  {{ doc.status.nombre }}
                </span>
              </td>
              <td>{{ doc.currentArea?.nombre || 'Sin √°rea' }}</td>
              <td class="date">{{ formatDate(doc.created_at) }}</td>
              <td class="actions-cell">
                <button 
                  *hasAnyPermission="['documents.view.all', 'documents.view.area', 'documents.view.own', 'area_mgmt.documents.view', 'area_mgmt.documents.view.own']"
                  class="btn-action btn-view" 
                  (click)="openDetailsModal(doc); $event.stopPropagation()" 
                  title="Ver detalles"
                >
                  <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                  </svg>
                </button>
                <button 
                  *hasAnyPermission="['documents.derive', 'area_mgmt.documents.derive']"
                  class="btn-action btn-derive" 
                  (click)="openDeriveModal(doc); $event.stopPropagation()" 
                  title="Derivar"
                >
                  üì§
                </button>
                <button 
                  *hasAnyPermission="['documents.archive', 'area_mgmt.documents.archive']"
                  class="btn-action btn-archive" 
                  (click)="archiveDocument(doc); $event.stopPropagation()" 
                  title="Archivar"
                >
                  üóÑÔ∏è
                </button>
              </td>
            </tr>
          </tbody>
        </table>

        <!-- Paginaci√≥n -->
        <div class="pagination" *ngIf="!loading() && filteredDocuments().length > 0">
          <div class="pagination-info">
            <span>Mostrando {{ (currentPage() - 1) * pageSize() + 1 }} - {{ Math.min(currentPage() * pageSize(), filteredDocuments().length) }} de {{ filteredDocuments().length }} documentos</span>
            <select class="page-size-select" [(ngModel)]="pageSize" (ngModelChange)="setPageSize($event)">
              <option [value]="10">10 por p√°gina</option>
              <option [value]="25">25 por p√°gina</option>
              <option [value]="50">50 por p√°gina</option>
              <option [value]="100">100 por p√°gina</option>
            </select>
          </div>
          
          <div class="pagination-controls">
            <button 
              class="pagination-btn" 
              (click)="previousPage()" 
              [disabled]="currentPage() === 1"
            >
              ‚Üê Anterior
            </button>
            
            <div class="pagination-pages">
              @for (page of [].constructor(totalPages()); track $index) {
                <button 
                  class="pagination-page" 
                  [class.active]="currentPage() === $index + 1"
                  (click)="goToPage($index + 1)"
                >
                  {{ $index + 1 }}
                </button>
              }
            </div>
            
            <button 
              class="pagination-btn" 
              (click)="nextPage()" 
              [disabled]="currentPage() === totalPages()"
            >
              Siguiente ‚Üí
            </button>
          </div>
        </div>
      </div>
    </div>

  </main>
</div>

<!-- Modal de Derivaci√≥n -->
@if (showDeriveModal()) {
  <app-document-derive
    [documentId]="selectedDocument().id"
    [documentCode]="selectedDocument().trackingCode"
    [documentSubject]="selectedDocument().asunto"
    [currentArea]="selectedDocument().currentArea?.nombre || 'Sin √°rea'"
    (onClose)="closeDeriveModal()"
    (onSuccess)="onDeriveSuccess()"
  ></app-document-derive>
}

<!-- Modal de Detalles -->
@if (showDetailsModal()) {
  <app-document-details
    [documentId]="selectedDocumentId()"
    (onClose)="closeDetailsModal()"
  ></app-document-details>
}
